(function(S,d){typeof exports=="object"&&typeof module<"u"?d(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],d):(S=typeof globalThis<"u"?globalThis:S||self,d(S.ReactCropOptimizer={},S.React))})(this,function(S,d){"use strict";const U=Math.PI/180;async function H(a,t,e,r=1,i=0){const n=t.getContext("2d");if(!n)throw new Error("No 2d context");const h=a.naturalWidth/a.width,u=a.naturalHeight/a.height,s=window.devicePixelRatio;t.width=Math.floor(e.width*h*s),t.height=Math.floor(e.height*u*s),n.scale(s,s),n.imageSmoothingQuality="high";const o=e.x*h,c=e.y*u,w=i*U,g=a.naturalWidth/2,l=a.naturalHeight/2;n.save(),n.translate(-o,-c),n.translate(g,l),n.rotate(w),n.scale(r,r),n.translate(-g,-l),n.drawImage(a,0,0,a.naturalWidth,a.naturalHeight,0,0,a.naturalWidth,a.naturalHeight),n.restore()}function K(a,t,e=[]){d.useEffect(()=>{const r=setTimeout(()=>{a()},t);return()=>{clearTimeout(r)}},e)}const $={x:0,y:0,width:0,height:0,unit:"px"},I=(a,t,e)=>Math.min(Math.max(a,t),e),z=(...a)=>a.filter(t=>t&&typeof t=="string").join(" "),O=(a,t)=>a===t||a.width===t.width&&a.height===t.height&&a.x===t.x&&a.y===t.y&&a.unit===t.unit;function T(a,t,e,r){const i=M(a,e,r);return a.width&&(i.height=i.width/t),a.height&&(i.width=i.height*t),i.y+i.height>r&&(i.height=r-i.y,i.width=i.height*t),i.x+i.width>e&&(i.width=e-i.x,i.height=i.width/t),a.unit==="%"?P(i,e,r):i}function R(a,t,e){const r=M(a,t,e);return r.x=(t-r.width)/2,r.y=(e-r.height)/2,a.unit==="%"?P(r,t,e):r}function P(a,t,e){return a.unit==="%"?{...$,...a,unit:"%"}:{unit:"%",x:a.x?a.x/t*100:0,y:a.y?a.y/e*100:0,width:a.width?a.width/t*100:0,height:a.height?a.height/e*100:0}}function M(a,t,e){return a.unit?a.unit==="px"?{...$,...a,unit:"px"}:{unit:"px",x:a.x?a.x*t/100:0,y:a.y?a.y*e/100:0,width:a.width?a.width*t/100:0,height:a.height?a.height*e/100:0}:{...$,...a,unit:"px"}}function A(a,t,e,r,i,n=0,h=0,u=r,s=i){const o={...a};let c=Math.min(n,r),w=Math.min(h,i),g=Math.min(u,r),l=Math.min(s,i);t&&(t>1?(c=h?h*t:c,w=c/t,g=u*t):(w=n?n/t:w,c=w*t,l=s/t)),o.y<0&&(o.height=Math.max(o.height+o.y,w),o.y=0),o.x<0&&(o.width=Math.max(o.width+o.x,c),o.x=0);const x=r-(o.x+o.width);x<0&&(o.x=Math.min(o.x,r-c),o.width+=x);const b=i-(o.y+o.height);if(b<0&&(o.y=Math.min(o.y,i-w),o.height+=b),o.width<c&&((e==="sw"||e=="nw")&&(o.x-=c-o.width),o.width=c),o.height<w&&((e==="nw"||e=="ne")&&(o.y-=w-o.height),o.height=w),o.width>g&&((e==="sw"||e=="nw")&&(o.x-=g-o.width),o.width=g),o.height>l&&((e==="nw"||e=="ne")&&(o.y-=l-o.height),o.height=l),t){const Y=o.width/o.height;if(Y<t){const p=Math.max(o.width/t,w);(e==="nw"||e=="ne")&&(o.y-=p-o.height),o.height=p}else if(Y>t){const p=Math.max(o.height*t,c);(e==="sw"||e=="nw")&&(o.x-=p-o.width),o.width=p}}return o}function F(a,t,e,r){const i={...a};return t==="ArrowLeft"?r==="nw"?(i.x-=e,i.y-=e,i.width+=e,i.height+=e):r==="w"?(i.x-=e,i.width+=e):r==="sw"?(i.x-=e,i.width+=e,i.height+=e):r==="ne"?(i.y+=e,i.width-=e,i.height-=e):r==="e"?i.width-=e:r==="se"&&(i.width-=e,i.height-=e):t==="ArrowRight"&&(r==="nw"?(i.x+=e,i.y+=e,i.width-=e,i.height-=e):r==="w"?(i.x+=e,i.width-=e):r==="sw"?(i.x+=e,i.width-=e,i.height-=e):r==="ne"?(i.y-=e,i.width+=e,i.height+=e):r==="e"?i.width+=e:r==="se"&&(i.width+=e,i.height+=e)),t==="ArrowUp"?r==="nw"?(i.x-=e,i.y-=e,i.width+=e,i.height+=e):r==="n"?(i.y-=e,i.height+=e):r==="ne"?(i.y-=e,i.width+=e,i.height+=e):r==="sw"?(i.x+=e,i.width-=e,i.height-=e):r==="s"?i.height-=e:r==="se"&&(i.width-=e,i.height-=e):t==="ArrowDown"&&(r==="nw"?(i.x+=e,i.y+=e,i.width-=e,i.height-=e):r==="n"?(i.y+=e,i.height-=e):r==="ne"?(i.y+=e,i.width-=e,i.height-=e):r==="sw"?(i.x-=e,i.width+=e,i.height+=e):r==="s"?i.height+=e:r==="se"&&(i.width+=e,i.height+=e)),i}const X={capture:!0,passive:!1};let j=0;const f=class f extends d.PureComponent{constructor(){super(...arguments),this.docMoveBound=!1,this.mouseDownOnCrop=!1,this.dragStarted=!1,this.evData={startClientX:0,startClientY:0,startCropX:0,startCropY:0,clientX:0,clientY:0,isResize:!0},this.componentRef=d.createRef(),this.mediaRef=d.createRef(),this.initChangeCalled=!1,this.instanceId=`rc-${j++}`,this.state={cropIsActive:!1,newCropIsBeingDrawn:!1},this.onCropPointerDown=t=>{const{crop:e,disabled:r}=this.props,i=this.getBox();if(!e)return;const n=M(e,i.width,i.height);if(r)return;t.cancelable&&t.preventDefault(),this.bindDocMove(),this.componentRef.current.focus({preventScroll:!0});const h=t.target.dataset.ord,u=!!h;let s=t.clientX,o=t.clientY,c=n.x,w=n.y;if(h){const g=t.clientX-i.x,l=t.clientY-i.y;let x=0,b=0;h==="ne"||h=="e"?(x=g-(n.x+n.width),b=l-n.y,c=n.x,w=n.y+n.height):h==="se"||h==="s"?(x=g-(n.x+n.width),b=l-(n.y+n.height),c=n.x,w=n.y):h==="sw"||h=="w"?(x=g-n.x,b=l-(n.y+n.height),c=n.x+n.width,w=n.y):(h==="nw"||h=="n")&&(x=g-n.x,b=l-n.y,c=n.x+n.width,w=n.y+n.height),s=c+i.x+x,o=w+i.y+b}this.evData={startClientX:s,startClientY:o,startCropX:c,startCropY:w,clientX:t.clientX,clientY:t.clientY,isResize:u,ord:h},this.mouseDownOnCrop=!0,this.setState({cropIsActive:!0})},this.onComponentPointerDown=t=>{const{crop:e,disabled:r,locked:i,keepSelection:n,onChange:h}=this.props,u=this.getBox();if(r||i||n&&e)return;t.cancelable&&t.preventDefault(),this.bindDocMove(),this.componentRef.current.focus({preventScroll:!0});const s=t.clientX-u.x,o=t.clientY-u.y,c={unit:"px",x:s,y:o,width:0,height:0};this.evData={startClientX:t.clientX,startClientY:t.clientY,startCropX:s,startCropY:o,clientX:t.clientX,clientY:t.clientY,isResize:!0},this.mouseDownOnCrop=!0,h(M(c,u.width,u.height),P(c,u.width,u.height)),this.setState({cropIsActive:!0,newCropIsBeingDrawn:!0})},this.onDocPointerMove=t=>{const{crop:e,disabled:r,onChange:i,onDragStart:n}=this.props,h=this.getBox();if(r||!e||!this.mouseDownOnCrop)return;t.cancelable&&t.preventDefault(),this.dragStarted||(this.dragStarted=!0,n&&n(t));const{evData:u}=this;u.clientX=t.clientX,u.clientY=t.clientY;let s;u.isResize?s=this.resizeCrop():s=this.dragCrop(),O(e,s)||i(M(s,h.width,h.height),P(s,h.width,h.height))},this.onComponentKeyDown=t=>{const{crop:e,disabled:r,onChange:i,onComplete:n}=this.props;if(r)return;const h=t.key;let u=!1;if(!e)return;const s=this.getBox(),o=this.makePixelCrop(s),w=(navigator.platform.match("Mac")?t.metaKey:t.ctrlKey)?f.nudgeStepLarge:t.shiftKey?f.nudgeStepMedium:f.nudgeStep;if(h==="ArrowLeft"?(o.x-=w,u=!0):h==="ArrowRight"?(o.x+=w,u=!0):h==="ArrowUp"?(o.y-=w,u=!0):h==="ArrowDown"&&(o.y+=w,u=!0),u){t.cancelable&&t.preventDefault(),o.x=I(o.x,0,s.width-o.width),o.y=I(o.y,0,s.height-o.height);const g=M(o,s.width,s.height),l=P(o,s.width,s.height);i(g,l),n&&n(g,l)}},this.onHandlerKeyDown=(t,e)=>{const{aspect:r=0,crop:i,disabled:n,minWidth:h=0,minHeight:u=0,maxWidth:s,maxHeight:o,onChange:c,onComplete:w}=this.props,g=this.getBox();if(n||!i)return;if(t.key==="ArrowUp"||t.key==="ArrowDown"||t.key==="ArrowLeft"||t.key==="ArrowRight")t.stopPropagation(),t.preventDefault();else return;const x=(navigator.platform.match("Mac")?t.metaKey:t.ctrlKey)?f.nudgeStepLarge:t.shiftKey?f.nudgeStepMedium:f.nudgeStep,b=M(i,g.width,g.height),Y=F(b,t.key,x,e),p=A(Y,r,e,g.width,g.height,h,u,s,o);if(!O(i,p)){const N=P(p,g.width,g.height);c(p,N),w&&w(p,N)}},this.onDocPointerDone=t=>{const{crop:e,disabled:r,onComplete:i,onDragEnd:n}=this.props,h=this.getBox();this.unbindDocMove(),!(r||!e)&&this.mouseDownOnCrop&&(this.mouseDownOnCrop=!1,this.dragStarted=!1,n&&n(t),i&&i(M(e,h.width,h.height),P(e,h.width,h.height)),this.setState({cropIsActive:!1,newCropIsBeingDrawn:!1}))},this.onDragFocus=()=>{var t;(t=this.componentRef.current)==null||t.scrollTo(0,0)}}get document(){return document}getBox(){const t=this.mediaRef.current;if(!t)return{x:0,y:0,width:0,height:0};const{x:e,y:r,width:i,height:n}=t.getBoundingClientRect();return{x:e,y:r,width:i,height:n}}componentDidUpdate(t){const{crop:e,onComplete:r}=this.props;if(r&&!t.crop&&e){const{width:i,height:n}=this.getBox();i&&n&&r(M(e,i,n),P(e,i,n))}}componentWillUnmount(){this.resizeObserver&&this.resizeObserver.disconnect(),this.unbindDocMove()}bindDocMove(){this.docMoveBound||(this.document.addEventListener("pointermove",this.onDocPointerMove,X),this.document.addEventListener("pointerup",this.onDocPointerDone,X),this.document.addEventListener("pointercancel",this.onDocPointerDone,X),this.docMoveBound=!0)}unbindDocMove(){this.docMoveBound&&(this.document.removeEventListener("pointermove",this.onDocPointerMove,X),this.document.removeEventListener("pointerup",this.onDocPointerDone,X),this.document.removeEventListener("pointercancel",this.onDocPointerDone,X),this.docMoveBound=!1)}getCropStyle(){const{crop:t}=this.props;if(t)return{top:`${t.y}${t.unit}`,left:`${t.x}${t.unit}`,width:`${t.width}${t.unit}`,height:`${t.height}${t.unit}`}}dragCrop(){const{evData:t}=this,e=this.getBox(),r=this.makePixelCrop(e),i=t.clientX-t.startClientX,n=t.clientY-t.startClientY;return r.x=I(t.startCropX+i,0,e.width-r.width),r.y=I(t.startCropY+n,0,e.height-r.height),r}getPointRegion(t,e,r,i){const{evData:n}=this,h=n.clientX-t.x,u=n.clientY-t.y;let s;i&&e?s=e==="nw"||e==="n"||e==="ne":s=u<n.startCropY;let o;return r&&e?o=e==="nw"||e==="w"||e==="sw":o=h<n.startCropX,o?s?"nw":"sw":s?"ne":"se"}resolveMinDimensions(t,e,r=0,i=0){const n=Math.min(r,t.width),h=Math.min(i,t.height);return!e||!n&&!h?[n,h]:e>1?n?[n,n/e]:[h*e,h]:h?[h*e,h]:[n,n/e]}resizeCrop(){const{evData:t}=this,{aspect:e=0,maxWidth:r,maxHeight:i}=this.props,n=this.getBox(),[h,u]=this.resolveMinDimensions(n,e,this.props.minWidth,this.props.minHeight);let s=this.makePixelCrop(n);const o=this.getPointRegion(n,t.ord,h,u),c=t.ord||o;let w=t.clientX-t.startClientX,g=t.clientY-t.startClientY;(h&&c==="nw"||c==="w"||c==="sw")&&(w=Math.min(w,-h)),(u&&c==="nw"||c==="n"||c==="ne")&&(g=Math.min(g,-u));const l={unit:"px",x:0,y:0,width:0,height:0};o==="ne"?(l.x=t.startCropX,l.width=w,e?(l.height=l.width/e,l.y=t.startCropY-l.height):(l.height=Math.abs(g),l.y=t.startCropY-l.height)):o==="se"?(l.x=t.startCropX,l.y=t.startCropY,l.width=w,e?l.height=l.width/e:l.height=g):o==="sw"?(l.x=t.startCropX+w,l.y=t.startCropY,l.width=Math.abs(w),e?l.height=l.width/e:l.height=g):o==="nw"&&(l.x=t.startCropX+w,l.width=Math.abs(w),e?(l.height=l.width/e,l.y=t.startCropY-l.height):(l.height=Math.abs(g),l.y=t.startCropY+g));const x=A(l,e,o,n.width,n.height,h,u,r,i);return e||f.xyOrds.indexOf(c)>-1?s=x:f.xOrds.indexOf(c)>-1?(s.x=x.x,s.width=x.width):f.yOrds.indexOf(c)>-1&&(s.y=x.y,s.height=x.height),s.x=I(s.x,0,n.width-s.width),s.y=I(s.y,0,n.height-s.height),s}renderCropSelection(){const{ariaLabels:t=f.defaultProps.ariaLabels,disabled:e,locked:r,renderSelectionAddon:i,ruleOfThirds:n,crop:h}=this.props,u=this.getCropStyle();if(h)return d.createElement("div",{style:u,className:"ReactCrop__crop-selection",onPointerDown:this.onCropPointerDown,"aria-label":t.cropArea,tabIndex:0,onKeyDown:this.onComponentKeyDown,role:"group"},!e&&!r&&d.createElement("div",{className:"ReactCrop__drag-elements",onFocus:this.onDragFocus},d.createElement("div",{className:"ReactCrop__drag-bar ord-n","data-ord":"n"}),d.createElement("div",{className:"ReactCrop__drag-bar ord-e","data-ord":"e"}),d.createElement("div",{className:"ReactCrop__drag-bar ord-s","data-ord":"s"}),d.createElement("div",{className:"ReactCrop__drag-bar ord-w","data-ord":"w"}),d.createElement("div",{className:"ReactCrop__drag-handle ord-nw","data-ord":"nw",tabIndex:0,"aria-label":t.nwDragHandle,onKeyDown:s=>this.onHandlerKeyDown(s,"nw"),role:"button"}),d.createElement("div",{className:"ReactCrop__drag-handle ord-n","data-ord":"n",tabIndex:0,"aria-label":t.nDragHandle,onKeyDown:s=>this.onHandlerKeyDown(s,"n"),role:"button"}),d.createElement("div",{className:"ReactCrop__drag-handle ord-ne","data-ord":"ne",tabIndex:0,"aria-label":t.neDragHandle,onKeyDown:s=>this.onHandlerKeyDown(s,"ne"),role:"button"}),d.createElement("div",{className:"ReactCrop__drag-handle ord-e","data-ord":"e",tabIndex:0,"aria-label":t.eDragHandle,onKeyDown:s=>this.onHandlerKeyDown(s,"e"),role:"button"}),d.createElement("div",{className:"ReactCrop__drag-handle ord-se","data-ord":"se",tabIndex:0,"aria-label":t.seDragHandle,onKeyDown:s=>this.onHandlerKeyDown(s,"se"),role:"button"}),d.createElement("div",{className:"ReactCrop__drag-handle ord-s","data-ord":"s",tabIndex:0,"aria-label":t.sDragHandle,onKeyDown:s=>this.onHandlerKeyDown(s,"s"),role:"button"}),d.createElement("div",{className:"ReactCrop__drag-handle ord-sw","data-ord":"sw",tabIndex:0,"aria-label":t.swDragHandle,onKeyDown:s=>this.onHandlerKeyDown(s,"sw"),role:"button"}),d.createElement("div",{className:"ReactCrop__drag-handle ord-w","data-ord":"w",tabIndex:0,"aria-label":t.wDragHandle,onKeyDown:s=>this.onHandlerKeyDown(s,"w"),role:"button"})),i&&d.createElement("div",{className:"ReactCrop__selection-addon",onPointerDown:s=>s.stopPropagation()},i(this.state)),n&&d.createElement(d.Fragment,null,d.createElement("div",{className:"ReactCrop__rule-of-thirds-hz"}),d.createElement("div",{className:"ReactCrop__rule-of-thirds-vt"})))}makePixelCrop(t){const e={...$,...this.props.crop||{}};return M(e,t.width,t.height)}render(){const{aspect:t,children:e,circularCrop:r,className:i,crop:n,disabled:h,locked:u,style:s,ruleOfThirds:o}=this.props,{cropIsActive:c,newCropIsBeingDrawn:w}=this.state,g=n?this.renderCropSelection():null,l=z("ReactCrop",i,c&&"ReactCrop--active",h&&"ReactCrop--disabled",u&&"ReactCrop--locked",w&&"ReactCrop--new-crop",n&&t&&"ReactCrop--fixed-aspect",n&&r&&"ReactCrop--circular-crop",n&&o&&"ReactCrop--rule-of-thirds",!this.dragStarted&&n&&!n.width&&!n.height&&"ReactCrop--invisible-crop",r&&"ReactCrop--no-animate");return d.createElement("div",{ref:this.componentRef,className:l,style:s},d.createElement("div",{ref:this.mediaRef,className:"ReactCrop__child-wrapper",onPointerDown:this.onComponentPointerDown},e),n?d.createElement("svg",{className:"ReactCrop__crop-mask",width:"100%",height:"100%"},d.createElement("defs",null,d.createElement("mask",{id:`hole-${this.instanceId}`},d.createElement("rect",{width:"100%",height:"100%",fill:"white"}),r?d.createElement("ellipse",{cx:`${n.x+n.width/2}${n.unit}`,cy:`${n.y+n.height/2}${n.unit}`,rx:`${n.width/2}${n.unit}`,ry:`${n.height/2}${n.unit}`,fill:"black"}):d.createElement("rect",{x:`${n.x}${n.unit}`,y:`${n.y}${n.unit}`,width:`${n.width}${n.unit}`,height:`${n.height}${n.unit}`,fill:"black"}))),d.createElement("rect",{fill:"black",fillOpacity:.5,width:"100%",height:"100%",mask:`url(#hole-${this.instanceId})`})):void 0,g)}};f.xOrds=["e","w"],f.yOrds=["n","s"],f.xyOrds=["nw","ne","se","sw"],f.nudgeStep=1,f.nudgeStepMedium=10,f.nudgeStepLarge=100,f.defaultProps={ariaLabels:{cropArea:"Use the arrow keys to move the crop selection area",nwDragHandle:"Use the arrow keys to move the north west drag handle to change the crop selection area",nDragHandle:"Use the up and down arrow keys to move the north drag handle to change the crop selection area",neDragHandle:"Use the arrow keys to move the north east drag handle to change the crop selection area",eDragHandle:"Use the up and down arrow keys to move the east drag handle to change the crop selection area",seDragHandle:"Use the arrow keys to move the south east drag handle to change the crop selection area",sDragHandle:"Use the up and down arrow keys to move the south drag handle to change the crop selection area",swDragHandle:"Use the arrow keys to move the south west drag handle to change the crop selection area",wDragHandle:"Use the up and down arrow keys to move the west drag handle to change the crop selection area"}};let _=f;const B=d.forwardRef((a,t)=>{const{src:e,scale:r=1,rotate:i=0,optimized:n=!0,maxDimension:h=2e3,classNameImage:u,loader:s,classNameWrapper:o,refPreviewBox:c,...w}=a,g=d.useRef(null),[l,x]=d.useState(),[b,Y]=d.useState(""),[p,N]=d.useState(null),[L,q]=d.useState(null),Q=async()=>e,V=async()=>L||e,G=async(C="webp")=>{const m=g.current;if(!m||!p)throw new Error("Crop canvas does not exist");const y=m.naturalWidth/m.width,E=m.naturalHeight/m.height,v=new OffscreenCanvas(p.width*y,p.height*E),D=v.getContext("2d");if(!D)throw new Error("No 2d context");return D.drawImage(m,p.x*y,p.y*E,p.width*y,p.height*E,0,0,p.width*y,p.height*E),await v.convertToBlob({type:`image/${C}`})};d.useImperativeHandle(t,()=>({returnResult:G,returnOptimized:V,returnOriginal:Q})),K(async()=>{p!=null&&p.width&&(p!=null&&p.height)&&g.current&&(c!=null&&c.current)&&H(g.current,c.current,p,r,i)},100,[p,r,i]);const J=C=>new Promise(m=>{const y=document.createElement("canvas"),E=y.getContext("2d");let v=C.width,D=C.height;(v>h||D>h)&&(console.log(`init Image dimensions: ${C.width}x${C.height} pixels`),v>D?(D=D*h/v,v=h):(v=v*h/D,D=h),console.log("to Image dimenstion:",`${Math.floor(v)}x${Math.floor(D)} pixels`)),y.width=v,y.height=D,E==null||E.drawImage(C,0,0,v,D),y.toBlob(te=>{q(te)},"image/webp");const k=y.toDataURL("image/webp");m(k)});function W(){if(e){x(void 0);const C=e,m=new FileReader;m.addEventListener("load",()=>{var E;const y=new Image;y.onload=async()=>{var v,D;if(n)if(y.width>h||y.height>h||C.type!=="image/webp"){const k=await J(y);Y(k)}else Y(((v=m.result)==null?void 0:v.toString())||"");else Y(((D=m.result)==null?void 0:D.toString())||"")},y.src=((E=m.result)==null?void 0:E.toString())||""}),m.readAsDataURL(C)}}function Z(C,m,y){return R(T({unit:"%",width:90},y,C,m),C,m)}function ee(C){if(w.aspect){const{width:m,height:y}=C.currentTarget;x(Z(m,y,w.aspect))}}return d.useEffect(()=>{W()},[e]),d.createElement("div",{className:o||""},d.createElement(_,{crop:l,onChange:(C,m)=>x(m),onComplete:C=>N(C),...w},b?d.createElement("img",{className:u||"",ref:g,alt:"",src:b,style:{transform:`scale(${r}) rotate(${i}deg)`},onLoad:C=>{ee(C)}}):s||d.createElement("div",{className:"DefaultLoader"})))});B.displayName="ImageCropper",S.ImageCropper=B,S.canvasPreview=H,S.useDebounceEffect=K,Object.defineProperty(S,Symbol.toStringTag,{value:"Module"})});
