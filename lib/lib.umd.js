(function(S,c){typeof exports=="object"&&typeof module<"u"?c(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],c):(S=typeof globalThis<"u"?globalThis:S||self,c(S.ReactCropOptimizer={},S.React))})(this,function(S,c){"use strict";const X={x:0,y:0,width:0,height:0,unit:"px"},Y=(s,t,e)=>Math.min(Math.max(s,t),e),A=(...s)=>s.filter(t=>t&&typeof t=="string").join(" "),_=(s,t)=>s===t||s.width===t.width&&s.height===t.height&&s.x===t.x&&s.y===t.y&&s.unit===t.unit;function L(s,t,e,r){const n=M(s,e,r);return s.width&&(n.height=n.width/t),s.height&&(n.width=n.height*t),n.y+n.height>r&&(n.height=r-n.y,n.width=n.height*t),n.x+n.width>e&&(n.width=e-n.x,n.height=n.width/t),s.unit==="%"?I(n,e,r):n}function U(s,t,e){const r=M(s,t,e);return r.x=(t-r.width)/2,r.y=(e-r.height)/2,s.unit==="%"?I(r,t,e):r}function I(s,t,e){return s.unit==="%"?{...X,...s,unit:"%"}:{unit:"%",x:s.x?s.x/t*100:0,y:s.y?s.y/e*100:0,width:s.width?s.width/t*100:0,height:s.height?s.height/e*100:0}}function M(s,t,e){return s.unit?s.unit==="px"?{...X,...s,unit:"px"}:{unit:"px",x:s.x?s.x*t/100:0,y:s.y?s.y*e/100:0,width:s.width?s.width*t/100:0,height:s.height?s.height*e/100:0}:{...X,...s,unit:"px"}}function k(s,t,e,r,n,i=0,h=0,w=r,a=n){const o={...s};let l=Math.min(i,r),g=Math.min(h,n),u=Math.min(w,r),d=Math.min(a,n);t&&(t>1?(l=h?h*t:l,g=l/t,u=w*t):(g=i?i/t:g,l=g*t,d=a/t)),o.y<0&&(o.height=Math.max(o.height+o.y,g),o.y=0),o.x<0&&(o.width=Math.max(o.width+o.x,l),o.x=0);const y=r-(o.x+o.width);y<0&&(o.x=Math.min(o.x,r-l),o.width+=y);const v=n-(o.y+o.height);if(v<0&&(o.y=Math.min(o.y,n-g),o.height+=v),o.width<l&&((e==="sw"||e=="nw")&&(o.x-=l-o.width),o.width=l),o.height<g&&((e==="nw"||e=="ne")&&(o.y-=g-o.height),o.height=g),o.width>u&&((e==="sw"||e=="nw")&&(o.x-=u-o.width),o.width=u),o.height>d&&((e==="nw"||e=="ne")&&(o.y-=d-o.height),o.height=d),t){const b=o.width/o.height;if(b<t){const p=Math.max(o.width/t,g);(e==="nw"||e=="ne")&&(o.y-=p-o.height),o.height=p}else if(b>t){const p=Math.max(o.height*t,l);(e==="sw"||e=="nw")&&(o.x-=p-o.width),o.width=p}}return o}function z(s,t,e,r){const n={...s};return t==="ArrowLeft"?r==="nw"?(n.x-=e,n.y-=e,n.width+=e,n.height+=e):r==="w"?(n.x-=e,n.width+=e):r==="sw"?(n.x-=e,n.width+=e,n.height+=e):r==="ne"?(n.y+=e,n.width-=e,n.height-=e):r==="e"?n.width-=e:r==="se"&&(n.width-=e,n.height-=e):t==="ArrowRight"&&(r==="nw"?(n.x+=e,n.y+=e,n.width-=e,n.height-=e):r==="w"?(n.x+=e,n.width-=e):r==="sw"?(n.x+=e,n.width-=e,n.height-=e):r==="ne"?(n.y-=e,n.width+=e,n.height+=e):r==="e"?n.width+=e:r==="se"&&(n.width+=e,n.height+=e)),t==="ArrowUp"?r==="nw"?(n.x-=e,n.y-=e,n.width+=e,n.height+=e):r==="n"?(n.y-=e,n.height+=e):r==="ne"?(n.y-=e,n.width+=e,n.height+=e):r==="sw"?(n.x+=e,n.width-=e,n.height-=e):r==="s"?n.height-=e:r==="se"&&(n.width-=e,n.height-=e):t==="ArrowDown"&&(r==="nw"?(n.x+=e,n.y+=e,n.width-=e,n.height-=e):r==="n"?(n.y+=e,n.height-=e):r==="ne"?(n.y+=e,n.width-=e,n.height-=e):r==="sw"?(n.x-=e,n.width+=e,n.height+=e):r==="s"?n.height+=e:r==="se"&&(n.width+=e,n.height+=e)),n}const $={capture:!0,passive:!1};let T=0;const H=class E extends c.PureComponent{constructor(){super(...arguments),this.docMoveBound=!1,this.mouseDownOnCrop=!1,this.dragStarted=!1,this.evData={startClientX:0,startClientY:0,startCropX:0,startCropY:0,clientX:0,clientY:0,isResize:!0},this.componentRef=c.createRef(),this.mediaRef=c.createRef(),this.initChangeCalled=!1,this.instanceId=`rc-${T++}`,this.state={cropIsActive:!1,newCropIsBeingDrawn:!1},this.onCropPointerDown=t=>{const{crop:e,disabled:r}=this.props,n=this.getBox();if(!e)return;const i=M(e,n.width,n.height);if(r)return;t.cancelable&&t.preventDefault(),this.bindDocMove(),this.componentRef.current.focus({preventScroll:!0});const h=t.target.dataset.ord,w=!!h;let a=t.clientX,o=t.clientY,l=i.x,g=i.y;if(h){const u=t.clientX-n.x,d=t.clientY-n.y;let y=0,v=0;h==="ne"||h=="e"?(y=u-(i.x+i.width),v=d-i.y,l=i.x,g=i.y+i.height):h==="se"||h==="s"?(y=u-(i.x+i.width),v=d-(i.y+i.height),l=i.x,g=i.y):h==="sw"||h=="w"?(y=u-i.x,v=d-(i.y+i.height),l=i.x+i.width,g=i.y):(h==="nw"||h=="n")&&(y=u-i.x,v=d-i.y,l=i.x+i.width,g=i.y+i.height),a=l+n.x+y,o=g+n.y+v}this.evData={startClientX:a,startClientY:o,startCropX:l,startCropY:g,clientX:t.clientX,clientY:t.clientY,isResize:w,ord:h},this.mouseDownOnCrop=!0,this.setState({cropIsActive:!0})},this.onComponentPointerDown=t=>{const{crop:e,disabled:r,locked:n,keepSelection:i,onChange:h}=this.props,w=this.getBox();if(r||n||i&&e)return;t.cancelable&&t.preventDefault(),this.bindDocMove(),this.componentRef.current.focus({preventScroll:!0});const a=t.clientX-w.x,o=t.clientY-w.y,l={unit:"px",x:a,y:o,width:0,height:0};this.evData={startClientX:t.clientX,startClientY:t.clientY,startCropX:a,startCropY:o,clientX:t.clientX,clientY:t.clientY,isResize:!0},this.mouseDownOnCrop=!0,h(M(l,w.width,w.height),I(l,w.width,w.height)),this.setState({cropIsActive:!0,newCropIsBeingDrawn:!0})},this.onDocPointerMove=t=>{const{crop:e,disabled:r,onChange:n,onDragStart:i}=this.props,h=this.getBox();if(r||!e||!this.mouseDownOnCrop)return;t.cancelable&&t.preventDefault(),this.dragStarted||(this.dragStarted=!0,i&&i(t));const{evData:w}=this;w.clientX=t.clientX,w.clientY=t.clientY;let a;w.isResize?a=this.resizeCrop():a=this.dragCrop(),_(e,a)||n(M(a,h.width,h.height),I(a,h.width,h.height))},this.onComponentKeyDown=t=>{const{crop:e,disabled:r,onChange:n,onComplete:i}=this.props;if(r)return;const h=t.key;let w=!1;if(!e)return;const a=this.getBox(),o=this.makePixelCrop(a),l=(navigator.platform.match("Mac")?t.metaKey:t.ctrlKey)?E.nudgeStepLarge:t.shiftKey?E.nudgeStepMedium:E.nudgeStep;if(h==="ArrowLeft"?(o.x-=l,w=!0):h==="ArrowRight"?(o.x+=l,w=!0):h==="ArrowUp"?(o.y-=l,w=!0):h==="ArrowDown"&&(o.y+=l,w=!0),w){t.cancelable&&t.preventDefault(),o.x=Y(o.x,0,a.width-o.width),o.y=Y(o.y,0,a.height-o.height);const g=M(o,a.width,a.height),u=I(o,a.width,a.height);n(g,u),i&&i(g,u)}},this.onHandlerKeyDown=(t,e)=>{const{aspect:r=0,crop:n,disabled:i,minWidth:h=0,minHeight:w=0,maxWidth:a,maxHeight:o,onChange:l,onComplete:g}=this.props,u=this.getBox();if(i||!n)return;if(t.key==="ArrowUp"||t.key==="ArrowDown"||t.key==="ArrowLeft"||t.key==="ArrowRight")t.stopPropagation(),t.preventDefault();else return;const d=(navigator.platform.match("Mac")?t.metaKey:t.ctrlKey)?E.nudgeStepLarge:t.shiftKey?E.nudgeStepMedium:E.nudgeStep,y=M(n,u.width,u.height),v=z(y,t.key,d,e),b=k(v,r,e,u.width,u.height,h,w,a,o);if(!_(n,b)){const p=I(b,u.width,u.height);l(b,p),g&&g(b,p)}},this.onDocPointerDone=t=>{const{crop:e,disabled:r,onComplete:n,onDragEnd:i}=this.props,h=this.getBox();this.unbindDocMove(),!(r||!e)&&this.mouseDownOnCrop&&(this.mouseDownOnCrop=!1,this.dragStarted=!1,i&&i(t),n&&n(M(e,h.width,h.height),I(e,h.width,h.height)),this.setState({cropIsActive:!1,newCropIsBeingDrawn:!1}))},this.onDragFocus=()=>{var t;(t=this.componentRef.current)==null||t.scrollTo(0,0)}}get document(){return document}getBox(){const t=this.mediaRef.current;if(!t)return{x:0,y:0,width:0,height:0};const{x:e,y:r,width:n,height:i}=t.getBoundingClientRect();return{x:e,y:r,width:n,height:i}}componentDidUpdate(t){const{crop:e,onComplete:r}=this.props;if(r&&!t.crop&&e){const{width:n,height:i}=this.getBox();n&&i&&r(M(e,n,i),I(e,n,i))}}componentWillUnmount(){this.resizeObserver&&this.resizeObserver.disconnect()}bindDocMove(){this.docMoveBound||(this.document.addEventListener("pointermove",this.onDocPointerMove,$),this.document.addEventListener("pointerup",this.onDocPointerDone,$),this.document.addEventListener("pointercancel",this.onDocPointerDone,$),this.docMoveBound=!0)}unbindDocMove(){this.docMoveBound&&(this.document.removeEventListener("pointermove",this.onDocPointerMove,$),this.document.removeEventListener("pointerup",this.onDocPointerDone,$),this.document.removeEventListener("pointercancel",this.onDocPointerDone,$),this.docMoveBound=!1)}getCropStyle(){const{crop:t}=this.props;if(t)return{top:`${t.y}${t.unit}`,left:`${t.x}${t.unit}`,width:`${t.width}${t.unit}`,height:`${t.height}${t.unit}`}}dragCrop(){const{evData:t}=this,e=this.getBox(),r=this.makePixelCrop(e),n=t.clientX-t.startClientX,i=t.clientY-t.startClientY;return r.x=Y(t.startCropX+n,0,e.width-r.width),r.y=Y(t.startCropY+i,0,e.height-r.height),r}getPointRegion(t,e,r,n){const{evData:i}=this,h=i.clientX-t.x,w=i.clientY-t.y;let a;n&&e?a=e==="nw"||e==="n"||e==="ne":a=w<i.startCropY;let o;return r&&e?o=e==="nw"||e==="w"||e==="sw":o=h<i.startCropX,o?a?"nw":"sw":a?"ne":"se"}resolveMinDimensions(t,e,r=0,n=0){const i=Math.min(r,t.width),h=Math.min(n,t.height);return!e||!i&&!h?[i,h]:e>1?i?[i,i/e]:[h*e,h]:h?[h*e,h]:[i,i/e]}resizeCrop(){const{evData:t}=this,{aspect:e=0,maxWidth:r,maxHeight:n}=this.props,i=this.getBox(),[h,w]=this.resolveMinDimensions(i,e,this.props.minWidth,this.props.minHeight);let a=this.makePixelCrop(i);const o=this.getPointRegion(i,t.ord,h,w),l=t.ord||o;let g=t.clientX-t.startClientX,u=t.clientY-t.startClientY;(h&&l==="nw"||l==="w"||l==="sw")&&(g=Math.min(g,-h)),(w&&l==="nw"||l==="n"||l==="ne")&&(u=Math.min(u,-w));const d={unit:"px",x:0,y:0,width:0,height:0};o==="ne"?(d.x=t.startCropX,d.width=g,e?(d.height=d.width/e,d.y=t.startCropY-d.height):(d.height=Math.abs(u),d.y=t.startCropY-d.height)):o==="se"?(d.x=t.startCropX,d.y=t.startCropY,d.width=g,e?d.height=d.width/e:d.height=u):o==="sw"?(d.x=t.startCropX+g,d.y=t.startCropY,d.width=Math.abs(g),e?d.height=d.width/e:d.height=u):o==="nw"&&(d.x=t.startCropX+g,d.width=Math.abs(g),e?(d.height=d.width/e,d.y=t.startCropY-d.height):(d.height=Math.abs(u),d.y=t.startCropY+u));const y=k(d,e,o,i.width,i.height,h,w,r,n);return e||E.xyOrds.indexOf(l)>-1?a=y:E.xOrds.indexOf(l)>-1?(a.x=y.x,a.width=y.width):E.yOrds.indexOf(l)>-1&&(a.y=y.y,a.height=y.height),a.x=Y(a.x,0,i.width-a.width),a.y=Y(a.y,0,i.height-a.height),a}renderCropSelection(){const{ariaLabels:t=E.defaultProps.ariaLabels,disabled:e,locked:r,renderSelectionAddon:n,ruleOfThirds:i,crop:h}=this.props,w=this.getCropStyle();if(h)return c.createElement("div",{style:w,className:"ReactCrop__crop-selection",onPointerDown:this.onCropPointerDown,"aria-label":t.cropArea,tabIndex:0,onKeyDown:this.onComponentKeyDown,role:"group"},!e&&!r&&c.createElement("div",{className:"ReactCrop__drag-elements",onFocus:this.onDragFocus},c.createElement("div",{className:"ReactCrop__drag-bar ord-n","data-ord":"n"}),c.createElement("div",{className:"ReactCrop__drag-bar ord-e","data-ord":"e"}),c.createElement("div",{className:"ReactCrop__drag-bar ord-s","data-ord":"s"}),c.createElement("div",{className:"ReactCrop__drag-bar ord-w","data-ord":"w"}),c.createElement("div",{className:"ReactCrop__drag-handle ord-nw","data-ord":"nw",tabIndex:0,"aria-label":t.nwDragHandle,onKeyDown:a=>this.onHandlerKeyDown(a,"nw"),role:"button"}),c.createElement("div",{className:"ReactCrop__drag-handle ord-n","data-ord":"n",tabIndex:0,"aria-label":t.nDragHandle,onKeyDown:a=>this.onHandlerKeyDown(a,"n"),role:"button"}),c.createElement("div",{className:"ReactCrop__drag-handle ord-ne","data-ord":"ne",tabIndex:0,"aria-label":t.neDragHandle,onKeyDown:a=>this.onHandlerKeyDown(a,"ne"),role:"button"}),c.createElement("div",{className:"ReactCrop__drag-handle ord-e","data-ord":"e",tabIndex:0,"aria-label":t.eDragHandle,onKeyDown:a=>this.onHandlerKeyDown(a,"e"),role:"button"}),c.createElement("div",{className:"ReactCrop__drag-handle ord-se","data-ord":"se",tabIndex:0,"aria-label":t.seDragHandle,onKeyDown:a=>this.onHandlerKeyDown(a,"se"),role:"button"}),c.createElement("div",{className:"ReactCrop__drag-handle ord-s","data-ord":"s",tabIndex:0,"aria-label":t.sDragHandle,onKeyDown:a=>this.onHandlerKeyDown(a,"s"),role:"button"}),c.createElement("div",{className:"ReactCrop__drag-handle ord-sw","data-ord":"sw",tabIndex:0,"aria-label":t.swDragHandle,onKeyDown:a=>this.onHandlerKeyDown(a,"sw"),role:"button"}),c.createElement("div",{className:"ReactCrop__drag-handle ord-w","data-ord":"w",tabIndex:0,"aria-label":t.wDragHandle,onKeyDown:a=>this.onHandlerKeyDown(a,"w"),role:"button"})),n&&c.createElement("div",{className:"ReactCrop__selection-addon",onPointerDown:a=>a.stopPropagation()},n(this.state)),i&&c.createElement(c.Fragment,null,c.createElement("div",{className:"ReactCrop__rule-of-thirds-hz"}),c.createElement("div",{className:"ReactCrop__rule-of-thirds-vt"})))}makePixelCrop(t){const e={...X,...this.props.crop||{}};return M(e,t.width,t.height)}render(){const{aspect:t,children:e,circularCrop:r,className:n,crop:i,disabled:h,locked:w,style:a,ruleOfThirds:o}=this.props,{cropIsActive:l,newCropIsBeingDrawn:g}=this.state,u=i?this.renderCropSelection():null,d=A("ReactCrop",n,l&&"ReactCrop--active",h&&"ReactCrop--disabled",w&&"ReactCrop--locked",g&&"ReactCrop--new-crop",i&&t&&"ReactCrop--fixed-aspect",i&&r&&"ReactCrop--circular-crop",i&&o&&"ReactCrop--rule-of-thirds",!this.dragStarted&&i&&!i.width&&!i.height&&"ReactCrop--invisible-crop",r&&"ReactCrop--no-animate");return c.createElement("div",{ref:this.componentRef,className:d,style:a},c.createElement("div",{ref:this.mediaRef,className:"ReactCrop__child-wrapper",onPointerDown:this.onComponentPointerDown},e),i?c.createElement("svg",{className:"ReactCrop__crop-mask",width:"100%",height:"100%"},c.createElement("defs",null,c.createElement("mask",{id:`hole-${this.instanceId}`},c.createElement("rect",{width:"100%",height:"100%",fill:"white"}),r?c.createElement("ellipse",{cx:`${i.x+i.width/2}${i.unit}`,cy:`${i.y+i.height/2}${i.unit}`,rx:`${i.width/2}${i.unit}`,ry:`${i.height/2}${i.unit}`,fill:"black"}):c.createElement("rect",{x:`${i.x}${i.unit}`,y:`${i.y}${i.unit}`,width:`${i.width}${i.unit}`,height:`${i.height}${i.unit}`,fill:"black"}))),c.createElement("rect",{fill:"black",fillOpacity:.5,width:"100%",height:"100%",mask:`url(#hole-${this.instanceId})`})):void 0,u)}};H.xOrds=["e","w"],H.yOrds=["n","s"],H.xyOrds=["nw","ne","se","sw"],H.nudgeStep=1,H.nudgeStepMedium=10,H.nudgeStepLarge=100,H.defaultProps={ariaLabels:{cropArea:"Use the arrow keys to move the crop selection area",nwDragHandle:"Use the arrow keys to move the north west drag handle to change the crop selection area",nDragHandle:"Use the up and down arrow keys to move the north drag handle to change the crop selection area",neDragHandle:"Use the arrow keys to move the north east drag handle to change the crop selection area",eDragHandle:"Use the up and down arrow keys to move the east drag handle to change the crop selection area",seDragHandle:"Use the arrow keys to move the south east drag handle to change the crop selection area",sDragHandle:"Use the up and down arrow keys to move the south drag handle to change the crop selection area",swDragHandle:"Use the arrow keys to move the south west drag handle to change the crop selection area",wDragHandle:"Use the up and down arrow keys to move the west drag handle to change the crop selection area"}};let W=H;const F=Math.PI/180;async function N(s,t,e,r=1,n=0){const i=t.getContext("2d");if(!i)throw new Error("No 2d context");const h=s.naturalWidth/s.width,w=s.naturalHeight/s.height,a=window.devicePixelRatio;t.width=Math.floor(e.width*h*a),t.height=Math.floor(e.height*w*a),i.scale(a,a),i.imageSmoothingQuality="high";const o=e.x*h,l=e.y*w,g=n*F,u=s.naturalWidth/2,d=s.naturalHeight/2;i.save(),i.translate(-o,-l),i.translate(u,d),i.rotate(g),i.scale(r,r),i.translate(-u,-d),i.drawImage(s,0,0,s.naturalWidth,s.naturalHeight,0,0,s.naturalWidth,s.naturalHeight),i.restore()}function O(s,t,e=[]){c.useEffect(()=>{const r=setTimeout(()=>{s()},t);return()=>{clearTimeout(r)}},e)}const K=c.forwardRef((s,t)=>{const{src:e,scale:r=1,rotate:n=0,optimized:i=!0,maxDimension:h=2e3,classNameImage:w,loader:a,classNameWrapper:o,refPreviewBox:l,...g}=s,u=c.useRef(null),[d,y]=c.useState(),[v,b]=c.useState(""),[p,j]=c.useState(null),[B,q]=c.useState(null),Q=async()=>e,G=async()=>B||e,J=async(x="webp")=>{const m=u.current;if(!m||!p)throw new Error("Crop canvas does not exist");const f=m.naturalWidth/m.width,R=m.naturalHeight/m.height,C=new OffscreenCanvas(p.width*f,p.height*R),D=C.getContext("2d");if(!D)throw new Error("No 2d context");return D.drawImage(m,p.x*f,p.y*R,p.width*f,p.height*R,0,0,p.width*f,p.height*R),await C.convertToBlob({type:`image/${x}`})};c.useImperativeHandle(t,()=>({returnResult:J,returnOptimized:G,returnOriginal:Q})),O(async()=>{p!=null&&p.width&&(p!=null&&p.height)&&u.current&&(l!=null&&l.current)&&N(u.current,l.current,p,r,n)},100,[p,r,n]);const V=x=>new Promise(m=>{const f=document.createElement("canvas"),R=f.getContext("2d");let C=x.width,D=x.height;(C>h||D>h)&&(console.log(`init Image dimensions: ${x.width}x${x.height} pixels`),C>D?(D=D*h/C,C=h):(C=C*h/D,D=h),console.log("to Image dimenstion:",`${Math.floor(C)}x${Math.floor(D)} pixels`)),f.width=C,f.height=D,R==null||R.drawImage(x,0,0,C,D),f.toBlob(ne=>{q(ne)},"image/webp");const P=f.toDataURL("image/webp");m(P)});function Z(){if(e){y(void 0);const x=e,m=new FileReader;m.addEventListener("load",()=>{var R;const f=new Image;f.onload=async()=>{var C,D;if(i)if(f.width>h||f.height>h||x.type!=="image/webp"){const P=await V(f);b(P)}else b(((C=m.result)==null?void 0:C.toString())||"");else b(((D=m.result)==null?void 0:D.toString())||"")},f.src=((R=m.result)==null?void 0:R.toString())||""}),m.readAsDataURL(x)}}function ee(x,m,f){return U(L({unit:"%",width:90},f,x,m),x,m)}function te(x){if(g.aspect){const{width:m,height:f}=x.currentTarget;y(ee(m,f,g.aspect))}}return c.useEffect(()=>{Z()},[e]),c.createElement("div",{className:o||""},c.createElement(W,{crop:d,onChange:(x,m)=>y(m),onComplete:x=>j(x),...g},v?c.createElement("img",{className:w||"",ref:u,alt:"",src:v,style:{transform:`scale(${r}) rotate(${n}deg)`},onLoad:x=>{te(x)}}):a||c.createElement("div",{className:"DefaultLoader"})))});K.displayName="ImageCropper",S.ImageCropper=K,S.canvasPreview=N,S.useDebounceEffect=O,Object.defineProperty(S,Symbol.toStringTag,{value:"Module"})});
